---
title: "knot_inferential"
author: "sven panis"
date: "2024-07-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

In knot_inferential.Rmd we fit Bayesian hazard models to the (person-trial-bin) data set, and calculate the effects of interest, following our (pre)registration on the OSF.

Load the libraries.

```{r load-pkg}
pkg <- c("cmdstanr", "standist", "tidyverse", "RColorBrewer", "patchwork", 
         "brms", "tidybayes", "bayesplot", "future", "parallel")

lapply(pkg, library, character.only = TRUE)
```

Set options.

```{r set-options}
options(brms.backend = "cmdstanr",
        mc.cores = parallel::detectCores(),
        future.fork.enable = TRUE,
        future.rng.onMisuse = "ignore") ## automatically set in RStudio

supportsMulticore()

detectCores()

#check info if needed:
#packageVersion("cmdstanr")
#devtools::session_info("rstan")
```

Prepare data

```{r}
# subjects 2, 3, 7,10, 16,17 and 19 have less than 80 percent of their RT in  range 600-1500

# read data
data_knot <- read_csv("data/inputfile_hazard_modeling_knot.csv")
head(data_knot)

# change column names
names(data_knot) <- c("pid","trial","day","training","condition","period","event")
summary(data_knot) # 20 pid, max 793 trials per pid, 5 days, 4 training, 20 conditions, 20 periods: 229,468 rows

# period 1: (0-75)
# period 2: (75-150)
# period 4: (225-300)
# period 8: (525-600)
# period 9: (600-675)
# period 10: (675-750)
# period 11: (750-825)
# period 12: (825-900)


# period 16: (1125-1200)
# period 20: (1425-1500)

# select period 9 - 20 : 12 periods of 75 ms
# center continous predictors
data_knot <- data_knot %>% 
  mutate(day_c = day - 5,  # center on day 5
         period_12 = period - 12) # center within-trial TIME on bin (1000,1100]

print(data_knot,n=30)

# delete early bins with few responses
data_knot <- data_knot %>% filter(period > 8) # 111507 rows


# create factor training
data_knot <- data_knot %>% 
  mutate(training = factor(training, levels=c(1:4),labels=c("Na","Ty","NaTy","None")),
         training = fct_relevel(training,c("None","Na","Ty","NaTy")))
summary(data_knot)
data_knot$training

# create dummies for levels of training
#data_sim_knot <- data_sim_knot %>% 
#  mutate(Na = ifelse(training==2,1,0),
#         Ty = ifelse(training==3,1,0),
#         NaTy = ifelse(training==4,1,0))

summary(data_knot) # 20 pid, max 793 trials per pid, 5 days, 4 training, 20 conditions, 12 periods: 111,507 rows

# remove unnecessary columns
data_knot <- data_knot %>% select(-c(trial, day, condition, period))
head(data_knot)

# remove some subjects
data_knot <- data_knot %>% filter(pid != 2) %>%
                           filter(pid != 3) %>%
                           filter(pid != 7) %>%
                           filter(pid != 10) %>%
                           filter(pid != 16) %>%
                           filter(pid != 17) %>%
                           filter(pid != 19)

unique(data_knot$pid)
# c(2, 3, 7,10, 16,17, 19)) # 70026 rows left
summary(data_knot)
```

Fit a Bayesian hazard model, to test how the effect of three types of training (naming, tying, naming+tying) play out concurrently on the within-trial and across-day time scales.

```{r}
priors <- c(
  set_prior("normal(0, 1)", class = "b"), # for beta parameters 
  set_prior("student_t(7.61, 0, 1.57)", class = "b", coef = "Intercept"), # flat prior for intercept on hazard scale
  set_prior("normal(0, 1)", class = "sd"),
  set_prior("lkj(2)", class = "cor")
)
```

Fit model with alternative specification

```{r}
plan(multicore)

model_knot <-
   brm(data = data_knot,
       family = binomial(link="cloglog"),
       event | trials(1) ~ 0 + Intercept + 
                           training*period_12*day_c +
                           training*I(period_12^2)*day_c +
                           training*period_12*I(day_c^2) +
                           training*I(period_12^2)*I(day_c^2) +
                           (1 + training*period_12*day_c +
                           training*I(period_12^2)*day_c +
                           training*period_12*I(day_c^2) +
                           training*I(period_12^2)*I(day_c^2)  | pid),
       prior = priors,
       chains = 4, cores = 8, iter = 3000, warmup = 1000,
       control = list(adapt_delta = 0.999, step_size = 0.04, max_treedepth = 12),
       seed = 12, init = "0",
       file = "models/model_knot")
```

```{r}
model_knot <- readRDS("models/model_knot.rds")
summary(model_knot)
effects <- get_variables(model_knot) 
fixed_effects <- fixef(model_knot)
random_effects <- ranef(model_knot)
```

# Extract posterior distributions, and visualize the effect of training type (vs. no training) for each combination of within-trial time period and day.

Plot using stat_lineribbon().

```{r}
post <-as_draws_df(model_knot) %>% # 500 x 956
   select(starts_with("b_")) %>%       # 500 x 36
   expand_grid(period_12 = -3:8) %>%   # 4000 x 37
   mutate(period_12sq = period_12^2)   # 4000 x 38

p1 <- post %>% 
  mutate(postdistr = b_Na + period_11 * `b_period_11:Na` + period_11sq * `b_Iperiod_11E2:Na`) %>%
  group_by(period_11) %>%
  
  ggplot(aes(x = period_11, y = postdistr)) +
  stat_lineribbon(show.legend=F) +
  scale_fill_brewer() +
  geom_hline(yintercept=0, linetype="dashed", color = "red") +
  scale_x_continuous(breaks = c(-3:4), labels=c(((-3:4)+11)*100),
                     limits = c(-3,4)) +
  labs(title = "Day 5", x = "time bin", y = "effect of N") +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle=90)) 

p2 <- post %>% 
  mutate(postdistr = b_Ty + period_11 * `b_period_11:Ty` + period_11sq * `b_Iperiod_11E2:Ty`) %>%
  group_by(period_11) %>%
  
  ggplot(aes(x = period_11, y = postdistr)) +
  stat_lineribbon(show.legend=F) +
  scale_fill_brewer() +
  geom_hline(yintercept=0, linetype="dashed", color = "red") +
  scale_x_continuous(breaks = c(-3:4), labels=c(((-3:4)+11)*100),
                     limits = c(-3,4)) +
  labs(x = "time bin", y = "effect of T") +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle=90)) 

p3 <- post %>% 
  mutate(postdistr = b_NaTy + period_11 * `b_period_11:NaTy` + period_11sq * `b_Iperiod_11E2:NaTy`) %>%
  group_by(period_11) %>%
  
  ggplot(aes(x = period_11, y = postdistr)) +
  stat_lineribbon(show.legend=F) +
  scale_fill_brewer() +
  geom_hline(yintercept=0, linetype="dashed", color = "red") +
  scale_x_continuous(breaks = c(-3:4), labels=c(((-3:4)+11)*100),
                     limits = c(-3,4)) +
  labs(x = "time bin", y = "effect of N+T") +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle=90)) 

# effects on day 4
p4 <- post %>% 
  mutate(day = -1,
         day_sq = day^2,
         postdistr = b_Na + period_11 * `b_period_11:Na` + period_11sq * `b_Iperiod_11E2:Na` + 
                     day * `b_Na:day_c`  +  day_sq * `b_Na:Iday_cE2` +  
                     period_11*day*`b_period_11:Na:day_c`  + period_11sq*day*`b_Iperiod_11E2:Na:day_c` + 
                     period_11*day_sq*`b_period_11:Na:Iday_cE2` + period_11sq*day_sq*`b_Iperiod_11E2:Na:Iday_cE2`) %>%
  group_by(period_11) %>%
  
  ggplot(aes(x = period_11, y = postdistr)) +
  stat_lineribbon(show.legend=F) +
  scale_fill_brewer() +
  geom_hline(yintercept=0, linetype="dashed", color = "red") +
  scale_x_continuous(breaks = c(-3:4), labels=c(((-3:4)+11)*100),
                     limits = c(-3,4)) +
  labs(title="Day 4", x = "time bin", y = "effect of N") +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle=90)) 

p5 <- post %>% 
  mutate(day = -1,
         day_sq = day^2,
         postdistr = b_Ty + period_11 * `b_period_11:Ty` + period_11sq * `b_Iperiod_11E2:Ty` + 
                     day * `b_Ty:day_c`  +  day_sq * `b_Ty:Iday_cE2` +  
                     period_11*day*`b_period_11:Ty:day_c`  + period_11sq*day*`b_Iperiod_11E2:Ty:day_c` + 
                     period_11*day_sq*`b_period_11:Ty:Iday_cE2` + period_11sq*day_sq*`b_Iperiod_11E2:Ty:Iday_cE2`) %>%
  group_by(period_11) %>%
  
  ggplot(aes(x = period_11, y = postdistr)) +
  stat_lineribbon(show.legend=F) +
  scale_fill_brewer() +
  geom_hline(yintercept=0, linetype="dashed", color = "red") +
  scale_x_continuous(breaks = c(-3:4), labels=c(((-3:4)+11)*100),
                     limits = c(-3,4)) +
  labs(x = "time bin", y = "effect of T") +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle=90)) 

p6 <- post %>% 
  mutate(day = -1,
         day_sq = day^2,
         postdistr = b_NaTy + period_11 * `b_period_11:NaTy` + period_11sq * `b_Iperiod_11E2:NaTy` + 
                     day * `b_NaTy:day_c`  +  day_sq * `b_NaTy:Iday_cE2` +  
                     period_11*day*`b_period_11:NaTy:day_c`  + period_11sq*day*`b_Iperiod_11E2:NaTy:day_c` + 
                     period_11*day_sq*`b_period_11:NaTy:Iday_cE2` + period_11sq*day_sq*`b_Iperiod_11E2:NaTy:Iday_cE2`) %>%
  group_by(period_11) %>%
  
  ggplot(aes(x = period_11, y = postdistr)) +
  stat_lineribbon(show.legend=F) +
  scale_fill_brewer() +
  geom_hline(yintercept=0, linetype="dashed", color = "red") +
  scale_x_continuous(breaks = c(-3:4), labels=c(((-3:4)+11)*100),
                     limits = c(-3,4)) +
  labs(x = "time bin", y = "effect of N+T") +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle=90)) 


# effects on day 3
p7 <- post %>% 
  mutate(day = -2,
         day_sq = day^2,
         postdistr = b_Na + period_11 * `b_period_11:Na` + period_11sq * `b_Iperiod_11E2:Na` + 
                     day * `b_Na:day_c`  +  day_sq * `b_Na:Iday_cE2` +  
                     period_11*day*`b_period_11:Na:day_c`  + period_11sq*day*`b_Iperiod_11E2:Na:day_c` + 
                     period_11*day_sq*`b_period_11:Na:Iday_cE2` + period_11sq*day_sq*`b_Iperiod_11E2:Na:Iday_cE2`) %>%
  group_by(period_11) %>%
  
  ggplot(aes(x = period_11, y = postdistr)) +
  stat_lineribbon(show.legend=F) +
  scale_fill_brewer() +
  geom_hline(yintercept=0, linetype="dashed", color = "red") +
  scale_x_continuous(breaks = c(-3:4), labels=c(((-3:4)+11)*100),
                     limits = c(-3,4)) +
  labs(title="Day 3", x = "time bin", y = "effect of N") +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle=90)) 

p8 <- post %>% 
  mutate(day = -2,
         day_sq = day^2,
         postdistr = b_Ty + period_11 * `b_period_11:Ty` + period_11sq * `b_Iperiod_11E2:Ty` + 
                     day * `b_Ty:day_c`  +  day_sq * `b_Ty:Iday_cE2` +  
                     period_11*day*`b_period_11:Ty:day_c`  + period_11sq*day*`b_Iperiod_11E2:Ty:day_c` + 
                     period_11*day_sq*`b_period_11:Ty:Iday_cE2` + period_11sq*day_sq*`b_Iperiod_11E2:Ty:Iday_cE2`) %>%
  group_by(period_11) %>%
  
  ggplot(aes(x = period_11, y = postdistr)) +
  stat_lineribbon(show.legend=F) +
  scale_fill_brewer() +
  geom_hline(yintercept=0, linetype="dashed", color = "red") +
  scale_x_continuous(breaks = c(-3:4), labels=c(((-3:4)+11)*100),
                     limits = c(-3,4)) +
  labs(x = "time bin", y = "effect of T") +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle=90)) 

p9 <- post %>% 
  mutate(day = -2,
         day_sq = day^2,
         postdistr = b_NaTy + period_11 * `b_period_11:NaTy` + period_11sq * `b_Iperiod_11E2:NaTy` + 
                     day * `b_NaTy:day_c`  +  day_sq * `b_NaTy:Iday_cE2` +  
                     period_11*day*`b_period_11:NaTy:day_c`  + period_11sq*day*`b_Iperiod_11E2:NaTy:day_c` + 
                     period_11*day_sq*`b_period_11:NaTy:Iday_cE2` + period_11sq*day_sq*`b_Iperiod_11E2:NaTy:Iday_cE2`) %>%
  group_by(period_11) %>%
  
  ggplot(aes(x = period_11, y = postdistr)) +
  stat_lineribbon(show.legend=F) +
  scale_fill_brewer() +
  geom_hline(yintercept=0, linetype="dashed", color = "red") +
  scale_x_continuous(breaks = c(-3:4), labels=c(((-3:4)+11)*100),
                     limits = c(-3,4)) +
  labs(x = "time bin", y = "effect of N+T") +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle=90)) 

# effects on day 2
p10 <- post %>% 
  mutate(day = -3,
         day_sq = day^2,
         postdistr = b_Na + period_11 * `b_period_11:Na` + period_11sq * `b_Iperiod_11E2:Na` + 
                     day * `b_Na:day_c`  +  day_sq * `b_Na:Iday_cE2` +  
                     period_11*day*`b_period_11:Na:day_c`  + period_11sq*day*`b_Iperiod_11E2:Na:day_c` + 
                     period_11*day_sq*`b_period_11:Na:Iday_cE2` + period_11sq*day_sq*`b_Iperiod_11E2:Na:Iday_cE2`) %>%
  group_by(period_11) %>%
  
  ggplot(aes(x = period_11, y = postdistr)) +
  stat_lineribbon(show.legend=F) +
  scale_fill_brewer() +
  geom_hline(yintercept=0, linetype="dashed", color = "red") +
  scale_x_continuous(breaks = c(-3:4), labels=c(((-3:4)+11)*100),
                     limits = c(-3,4)) +
  labs(title="Day 2", x = "time bin", y = "effect of N") +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle=90)) 

p11 <- post %>% 
  mutate(day = -3,
         day_sq = day^2,
         postdistr = b_Ty + period_11 * `b_period_11:Ty` + period_11sq * `b_Iperiod_11E2:Ty` + 
                     day * `b_Ty:day_c`  +  day_sq * `b_Ty:Iday_cE2` +  
                     period_11*day*`b_period_11:Ty:day_c`  + period_11sq*day*`b_Iperiod_11E2:Ty:day_c` + 
                     period_11*day_sq*`b_period_11:Ty:Iday_cE2` + period_11sq*day_sq*`b_Iperiod_11E2:Ty:Iday_cE2`) %>%
  group_by(period_11) %>%
  
  ggplot(aes(x = period_11, y = postdistr)) +
  stat_lineribbon(show.legend=F) +
  scale_fill_brewer() +
  geom_hline(yintercept=0, linetype="dashed", color = "red") +
  scale_x_continuous(breaks = c(-3:4), labels=c(((-3:4)+11)*100),
                     limits = c(-3,4)) +
  labs(x = "time bin", y = "effect of T") +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle=90)) 

p12 <- post %>% 
  mutate(day = -3,
         day_sq = day^2,
         postdistr = b_NaTy + period_11 * `b_period_11:NaTy` + period_11sq * `b_Iperiod_11E2:NaTy` + 
                     day * `b_NaTy:day_c`  +  day_sq * `b_NaTy:Iday_cE2` +  
                     period_11*day*`b_period_11:NaTy:day_c`  + period_11sq*day*`b_Iperiod_11E2:NaTy:day_c` + 
                     period_11*day_sq*`b_period_11:NaTy:Iday_cE2` + period_11sq*day_sq*`b_Iperiod_11E2:NaTy:Iday_cE2`) %>%
  group_by(period_11) %>%
  
  ggplot(aes(x = period_11, y = postdistr)) +
  stat_lineribbon(show.legend=F) +
  scale_fill_brewer() +
  geom_hline(yintercept=0, linetype="dashed", color = "red") +
  scale_x_continuous(breaks = c(-3:4), labels=c(((-3:4)+11)*100),
                     limits = c(-3,4)) +
  labs(x = "time bin", y = "effect of N+T") +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle=90)) 

# effects on day 1
p13 <- post %>% 
  mutate(day = -4,
         day_sq = day^2,
         postdistr = b_Na + period_11 * `b_period_11:Na` + period_11sq * `b_Iperiod_11E2:Na` + 
                     day * `b_Na:day_c`  +  day_sq * `b_Na:Iday_cE2` +  
                     period_11*day*`b_period_11:Na:day_c`  + period_11sq*day*`b_Iperiod_11E2:Na:day_c` + 
                     period_11*day_sq*`b_period_11:Na:Iday_cE2` + period_11sq*day_sq*`b_Iperiod_11E2:Na:Iday_cE2`) %>%
  group_by(period_11) %>%
  
  ggplot(aes(x = period_11, y = postdistr)) +
  stat_lineribbon(show.legend=F) +
  scale_fill_brewer() +
  geom_hline(yintercept=0, linetype="dashed", color = "red") +
  scale_x_continuous(breaks = c(-3:4), labels=c(((-3:4)+11)*100),
                     limits = c(-3,4)) +
  labs(title="Day 1", x = "time bin", y = "effect of N") +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle=90)) 

p14 <- post %>% 
  mutate(day = -4,
         day_sq = day^2,
         postdistr = b_Ty + period_11 * `b_period_11:Ty` + period_11sq * `b_Iperiod_11E2:Ty` + 
                     day * `b_Ty:day_c`  +  day_sq * `b_Ty:Iday_cE2` +  
                     period_11*day*`b_period_11:Ty:day_c`  + period_11sq*day*`b_Iperiod_11E2:Ty:day_c` + 
                     period_11*day_sq*`b_period_11:Ty:Iday_cE2` + period_11sq*day_sq*`b_Iperiod_11E2:Ty:Iday_cE2`) %>%
  group_by(period_11) %>%
  
  ggplot(aes(x = period_11, y = postdistr)) +
  stat_lineribbon() +
  scale_fill_brewer() +
  geom_hline(yintercept=0, linetype="dashed", color = "red") +
  scale_x_continuous(breaks = c(-3:4), labels=c(((-3:4)+11)*100),
                     limits = c(-3,4)) +
  labs(x = "time bin", y = "effect of T") +
  theme(panel.grid = element_blank(),
        legend.position = "bottom",
        legend.text = element_text(size=8),
        legend.title = element_text(size=8),
        legend.key.size = unit(.4, 'cm'),
        axis.text.x = element_text(angle=90)) 

p15 <- post %>% 
  mutate(day = -4,
         day_sq = day^2,
         postdistr = b_NaTy + period_11 * `b_period_11:NaTy` + period_11sq * `b_Iperiod_11E2:NaTy` + 
                     day * `b_NaTy:day_c`  +  day_sq * `b_NaTy:Iday_cE2` +  
                     period_11*day*`b_period_11:NaTy:day_c`  + period_11sq*day*`b_Iperiod_11E2:NaTy:day_c` + 
                     period_11*day_sq*`b_period_11:NaTy:Iday_cE2` + period_11sq*day_sq*`b_Iperiod_11E2:NaTy:Iday_cE2`) %>%
  group_by(period_11) %>%
  
  ggplot(aes(x = period_11, y = postdistr)) +
  stat_lineribbon(show.legend=F) +
  scale_fill_brewer() +
  geom_hline(yintercept=0, linetype="dashed", color = "red") +
  scale_x_continuous(breaks = c(-3:4), labels=c(((-3:4)+11)*100),
                     limits = c(-3,4)) +
  labs(x = "time bin", y = "effect of N+T") +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle=90)) 

(p1+p2+p3)/(p4+p5+p6)/(p7+p8+p9)/(p10+p11+p12)/(p13+p14+p15)

ggsave("figures/effects_sim_knot.png", width = 12, height = 16, dpi = 600)
```

Plot using stat_halfeye():

```{r}
post <-as_draws_df(model_sim_knot) %>% # 500 x 956
   select(starts_with("b_")) %>%       # 500 x 36
   expand_grid(period_11 = -3:4) %>%   # 4000 x 37
   mutate(period_11sq = period_11^2)

p1 <- post %>% 
  mutate(postdistr = b_Na + period_11 * `b_period_11:Na` + period_11sq * `b_Iperiod_11E2:Na`,
         period = factor(period_11, levels = c(-3:4), labels = c(8:15))) %>%
  group_by(period) %>%
  
  ggplot(aes(x = postdistr, y = period)) +
  stat_halfeye(point_interval="median_qi",.width = c(.50,.90)) +
  coord_flip() +
  geom_vline(xintercept=0, linetype="dashed", color = "red") +
  labs(title = "Day 5", y = "time bin", x = "effect of N") +
  theme(panel.grid = element_blank()) 

p2 <- post %>% 
  mutate(postdistr = b_Ty + period_11 * `b_period_11:Ty` + period_11sq * `b_Iperiod_11E2:Ty`,
         period = factor(period_11, levels = c(-3:4), labels = c(8:15))) %>%
  group_by(period) %>%
  
  ggplot(aes(x = postdistr, y = period)) +
  stat_halfeye(point_interval="median_qi",.width = c(.50,.90)) +
  coord_flip() +
  geom_vline(xintercept=0, linetype="dashed", color = "red") +
  labs(y = "time bin", x = "effect of T") +
  theme(panel.grid = element_blank()) 

p3 <- post %>% 
  mutate(postdistr = b_NaTy + period_11 * `b_period_11:NaTy` + period_11sq * `b_Iperiod_11E2:NaTy`,
         period = factor(period_11, levels = c(-3:4), labels = c(8:15))) %>%
  group_by(period) %>%
  
  ggplot(aes(x = postdistr, y = period)) +
  stat_halfeye(point_interval="median_qi",.width = c(.50,.90)) +
  coord_flip() +
  geom_vline(xintercept=0, linetype="dashed", color = "red") +
  labs(y = "time bin", x = "effect of N+T") +
  theme(panel.grid = element_blank()) 

# effects on day 4
p4 <- post %>% 
  mutate(day = -1,
         day_sq = day^2,
         postdistr = b_Na + period_11 * `b_period_11:Na` + period_11sq * `b_Iperiod_11E2:Na` + 
                     day * `b_Na:day_c`  +  day_sq * `b_Na:Iday_cE2` +  
                     period_11*day*`b_period_11:Na:day_c`  + period_11sq*day*`b_Iperiod_11E2:Na:day_c` + 
                     period_11*day_sq*`b_period_11:Na:Iday_cE2` + period_11sq*day_sq*`b_Iperiod_11E2:Na:Iday_cE2` ,
         period = factor(period_11, levels = c(-3:4), labels = c(8:15))) %>%
  group_by(period) %>%
  
  ggplot(aes(x = postdistr, y = period)) +
  stat_halfeye(point_interval="median_qi",.width = c(.50,.90)) +
  coord_flip() +
  geom_vline(xintercept=0, linetype="dashed", color = "red") +
  labs(title = "Day 4", y = "time bin", x = "effect of N") +
  theme(panel.grid = element_blank()) 

p5 <- post %>% 
  mutate(day = -1,
         day_sq = day^2,
         postdistr = b_Ty + period_11 * `b_period_11:Ty` + period_11sq * `b_Iperiod_11E2:Ty` + 
                     day * `b_Ty:day_c`  +  day_sq * `b_Ty:Iday_cE2` +  
                     period_11*day*`b_period_11:Ty:day_c`  + period_11sq*day*`b_Iperiod_11E2:Ty:day_c` + 
                     period_11*day_sq*`b_period_11:Ty:Iday_cE2` + period_11sq*day_sq*`b_Iperiod_11E2:Ty:Iday_cE2` ,
         period = factor(period_11, levels = c(-3:4), labels = c(8:15))) %>%
  group_by(period) %>%
  
  ggplot(aes(x = postdistr, y = period)) +
  stat_halfeye(point_interval="median_qi",.width = c(.50,.90)) +
  coord_flip() +
  geom_vline(xintercept=0, linetype="dashed", color = "red") +
  labs(y = "time bin", x = "effect of T") +
  theme(panel.grid = element_blank()) 

p6 <- post %>% 
  mutate(day = -1,
         day_sq = day^2,
         postdistr = b_NaTy + period_11 * `b_period_11:NaTy` + period_11sq * `b_Iperiod_11E2:NaTy` + 
                     day * `b_NaTy:day_c`  +  day_sq * `b_NaTy:Iday_cE2` +  
                     period_11*day*`b_period_11:NaTy:day_c`  + period_11sq*day*`b_Iperiod_11E2:NaTy:day_c` + 
                     period_11*day_sq*`b_period_11:NaTy:Iday_cE2` + period_11sq*day_sq*`b_Iperiod_11E2:NaTy:Iday_cE2` ,
         period = factor(period_11, levels = c(-3:4), labels = c(8:15))) %>%
  group_by(period) %>%
  
  ggplot(aes(x = postdistr, y = period)) +
  stat_halfeye(point_interval="median_qi",.width = c(.50,.90)) +
  coord_flip() +
  geom_vline(xintercept=0, linetype="dashed", color = "red") +
  labs(y = "time bin", x = "effect of N+T") +
  theme(panel.grid = element_blank()) 

# effects on day 3
p7 <- post %>% 
  mutate(day = -2,
         day_sq = day^2,
         postdistr = b_Na + period_11 * `b_period_11:Na` + period_11sq * `b_Iperiod_11E2:Na` + 
                     day * `b_Na:day_c`  +  day_sq * `b_Na:Iday_cE2` +  
                     period_11*day*`b_period_11:Na:day_c`  + period_11sq*day*`b_Iperiod_11E2:Na:day_c` + 
                     period_11*day_sq*`b_period_11:Na:Iday_cE2` + period_11sq*day_sq*`b_Iperiod_11E2:Na:Iday_cE2` ,
         period = factor(period_11, levels = c(-3:4), labels = c(8:15))) %>%
  group_by(period) %>%
  
  ggplot(aes(x = postdistr, y = period)) +
  stat_halfeye(point_interval="median_qi",.width = c(.50,.90)) +
  coord_flip() +
  geom_vline(xintercept=0, linetype="dashed", color = "red") +
  labs(title = "Day 3", y = "time bin", x = "effect of N") +
  theme(panel.grid = element_blank()) 

p8 <- post %>% 
  mutate(day = -2,
         day_sq = day^2,
         postdistr = b_Ty + period_11 * `b_period_11:Ty` + period_11sq * `b_Iperiod_11E2:Ty` + 
                     day * `b_Ty:day_c`  +  day_sq * `b_Ty:Iday_cE2` +  
                     period_11*day*`b_period_11:Ty:day_c`  + period_11sq*day*`b_Iperiod_11E2:Ty:day_c` + 
                     period_11*day_sq*`b_period_11:Ty:Iday_cE2` + period_11sq*day_sq*`b_Iperiod_11E2:Ty:Iday_cE2` ,
         period = factor(period_11, levels = c(-3:4), labels = c(8:15))) %>%
  group_by(period) %>%
  
  ggplot(aes(x = postdistr, y = period)) +
  stat_halfeye(point_interval="median_qi",.width = c(.50,.90)) +
  coord_flip() +
  geom_vline(xintercept=0, linetype="dashed", color = "red") +
  labs(y = "time bin", x = "effect of T") +
  theme(panel.grid = element_blank()) 

p9 <- post %>% 
  mutate(day = -2,
         day_sq = day^2,
         postdistr = b_NaTy + period_11 * `b_period_11:NaTy` + period_11sq * `b_Iperiod_11E2:NaTy` + 
                     day * `b_NaTy:day_c`  +  day_sq * `b_NaTy:Iday_cE2` +  
                     period_11*day*`b_period_11:NaTy:day_c`  + period_11sq*day*`b_Iperiod_11E2:NaTy:day_c` + 
                     period_11*day_sq*`b_period_11:NaTy:Iday_cE2` + period_11sq*day_sq*`b_Iperiod_11E2:NaTy:Iday_cE2` ,
         period = factor(period_11, levels = c(-3:4), labels = c(8:15))) %>%
  group_by(period) %>%
  
  ggplot(aes(x = postdistr, y = period)) +
  stat_halfeye(point_interval="median_qi",.width = c(.50,.90)) +
  coord_flip() +
  geom_vline(xintercept=0, linetype="dashed", color = "red") +
  labs(y = "time bin", x = "effect of N+T") +
  theme(panel.grid = element_blank()) 

# effects on day 2
p10 <- post %>% 
  mutate(day = -3,
         day_sq = day^2,
         postdistr = b_Na + period_11 * `b_period_11:Na` + period_11sq * `b_Iperiod_11E2:Na` + 
                     day * `b_Na:day_c`  +  day_sq * `b_Na:Iday_cE2` +  
                     period_11*day*`b_period_11:Na:day_c`  + period_11sq*day*`b_Iperiod_11E2:Na:day_c` + 
                     period_11*day_sq*`b_period_11:Na:Iday_cE2` + period_11sq*day_sq*`b_Iperiod_11E2:Na:Iday_cE2` ,
         period = factor(period_11, levels = c(-3:4), labels = c(8:15))) %>%
  group_by(period) %>%
  
  ggplot(aes(x = postdistr, y = period)) +
  stat_halfeye(point_interval="median_qi",.width = c(.50,.90)) +
  coord_flip() +
  geom_vline(xintercept=0, linetype="dashed", color = "red") +
  labs(title = "Day 2", y = "time bin", x = "effect of N") +
  theme(panel.grid = element_blank()) 

p11 <- post %>% 
  mutate(day = -3,
         day_sq = day^2,
         postdistr = b_Ty + period_11 * `b_period_11:Ty` + period_11sq * `b_Iperiod_11E2:Ty` + 
                     day * `b_Ty:day_c`  +  day_sq * `b_Ty:Iday_cE2` +  
                     period_11*day*`b_period_11:Ty:day_c`  + period_11sq*day*`b_Iperiod_11E2:Ty:day_c` + 
                     period_11*day_sq*`b_period_11:Ty:Iday_cE2` + period_11sq*day_sq*`b_Iperiod_11E2:Ty:Iday_cE2` ,
         period = factor(period_11, levels = c(-3:4), labels = c(8:15))) %>%
  group_by(period) %>%
  
  ggplot(aes(x = postdistr, y = period)) +
  stat_halfeye(point_interval="median_qi",.width = c(.50,.90)) +
  coord_flip() +
  geom_vline(xintercept=0, linetype="dashed", color = "red") +
  labs(y = "time bin", x = "effect of T") +
  theme(panel.grid = element_blank()) 

p12 <- post %>% 
  mutate(day = -3,
         day_sq = day^2,
         postdistr = b_NaTy + period_11 * `b_period_11:NaTy` + period_11sq * `b_Iperiod_11E2:NaTy` + 
                     day * `b_NaTy:day_c`  +  day_sq * `b_NaTy:Iday_cE2` +  
                     period_11*day*`b_period_11:NaTy:day_c`  + period_11sq*day*`b_Iperiod_11E2:NaTy:day_c` + 
                     period_11*day_sq*`b_period_11:NaTy:Iday_cE2` + period_11sq*day_sq*`b_Iperiod_11E2:NaTy:Iday_cE2` ,
         period = factor(period_11, levels = c(-3:4), labels = c(8:15))) %>%
  group_by(period) %>%
  
  ggplot(aes(x = postdistr, y = period)) +
  stat_halfeye(point_interval="median_qi",.width = c(.50,.90)) +
  coord_flip() +
  geom_vline(xintercept=0, linetype="dashed", color = "red") +
  labs(y = "time bin", x = "effect of N+T") +
  theme(panel.grid = element_blank()) 

# effects on day 1
p13 <- post %>% 
  mutate(day = -4,
         day_sq = day^2,
         postdistr = b_Na + period_11 * `b_period_11:Na` + period_11sq * `b_Iperiod_11E2:Na` + 
                     day * `b_Na:day_c`  +  day_sq * `b_Na:Iday_cE2` +  
                     period_11*day*`b_period_11:Na:day_c`  + period_11sq*day*`b_Iperiod_11E2:Na:day_c` + 
                     period_11*day_sq*`b_period_11:Na:Iday_cE2` + period_11sq*day_sq*`b_Iperiod_11E2:Na:Iday_cE2` ,
         period = factor(period_11, levels = c(-3:4), labels = c(8:15))) %>%
  group_by(period) %>%
  
  ggplot(aes(x = postdistr, y = period)) +
  stat_halfeye(point_interval="median_qi",.width = c(.50,.90)) +
  coord_flip() +
  geom_vline(xintercept=0, linetype="dashed", color = "red") +
  labs(title = "Day 2", y = "time bin", x = "effect of N") +
  theme(panel.grid = element_blank()) 

p14 <- post %>% 
  mutate(day = -4,
         day_sq = day^2,
         postdistr = b_Ty + period_11 * `b_period_11:Ty` + period_11sq * `b_Iperiod_11E2:Ty` + 
                     day * `b_Ty:day_c`  +  day_sq * `b_Ty:Iday_cE2` +  
                     period_11*day*`b_period_11:Ty:day_c`  + period_11sq*day*`b_Iperiod_11E2:Ty:day_c` + 
                     period_11*day_sq*`b_period_11:Ty:Iday_cE2` + period_11sq*day_sq*`b_Iperiod_11E2:Ty:Iday_cE2` ,
         period = factor(period_11, levels = c(-3:4), labels = c(8:15))) %>%
  group_by(period) %>%
  
  ggplot(aes(x = postdistr, y = period)) +
  stat_halfeye(point_interval="median_qi",.width = c(.50,.90)) +
  coord_flip() +
  geom_vline(xintercept=0, linetype="dashed", color = "red") +
  labs(y = "time bin", x = "effect of T") +
  theme(panel.grid = element_blank()) 

p15 <- post %>% 
  mutate(day = -4,
         day_sq = day^2,
         postdistr = b_NaTy + period_11 * `b_period_11:NaTy` + period_11sq * `b_Iperiod_11E2:NaTy` + 
                     day * `b_NaTy:day_c`  +  day_sq * `b_NaTy:Iday_cE2` +  
                     period_11*day*`b_period_11:NaTy:day_c`  + period_11sq*day*`b_Iperiod_11E2:NaTy:day_c` + 
                     period_11*day_sq*`b_period_11:NaTy:Iday_cE2` + period_11sq*day_sq*`b_Iperiod_11E2:NaTy:Iday_cE2` ,
         period = factor(period_11, levels = c(-3:4), labels = c(8:15))) %>%
  group_by(period) %>%
  
  ggplot(aes(x = postdistr, y = period)) +
  stat_halfeye(point_interval="median_qi",.width = c(.50,.90)) +
  coord_flip() +
  geom_vline(xintercept=0, linetype="dashed", color = "red") +
  labs(y = "time bin", x = "effect of N+T") +
  theme(panel.grid = element_blank()) 

(p1+p2+p3)/(p4+p5+p6)/(p7+p8+p9)/(p10+p11+p12)/(p13+p14+p15)
```
